# Task 3.1: Causal Graph Storage (SurrealDB)

## Status: [ ] Not Started

## Goal
Store PCMCI-discovered causal chains in SurrealDB.

## Output File
`src/data_manager/causal_graph.py`

## Dependencies
- SurrealDB running: `docker ps | grep surrealdb`
- `surrealdb` Python package (già in .venv)

## Code

```python
"""Causal Graph Storage - SurrealDB."""
from surrealdb import Surreal
from typing import List, Dict, Any
from dataclasses import dataclass


@dataclass
class CausalEdge:
    source_dataset: str
    source_variable: str
    target_dataset: str
    target_variable: str
    lag_days: int
    correlation: float
    physics_mechanism: str
    physics_score: float
    discovered_by: str


class CausalGraphDB:
    def __init__(self, url: str = "ws://localhost:8001/rpc"):
        self.url = url
        self.db = Surreal(url)
        self._initialized = False
    
    async def connect(self):
        await self.db.connect()
        await self.db.use("causal", "knowledge")
        if not self._initialized:
            await self._init_schema()
            self._initialized = True
    
    async def _init_schema(self):
        await self.db.query("""
            DEFINE TABLE IF NOT EXISTS dataset SCHEMAFULL;
            DEFINE FIELD id ON dataset TYPE string;
            DEFINE FIELD variables ON dataset TYPE array;
            DEFINE FIELD latency ON dataset TYPE string;
        """)
        await self.db.query("""
            DEFINE TABLE IF NOT EXISTS causal_edge SCHEMAFULL;
            DEFINE FIELD source ON causal_edge TYPE string;
            DEFINE FIELD target ON causal_edge TYPE string;
            DEFINE FIELD lag_days ON causal_edge TYPE int;
            DEFINE FIELD correlation ON causal_edge TYPE float;
            DEFINE FIELD physics_score ON causal_edge TYPE float;
            DEFINE FIELD discovered_by ON causal_edge TYPE string;
        """)
    
    async def add_edge(self, edge: CausalEdge):
        await self.db.query("""
            CREATE causal_edge SET
                source = $src,
                target = $tgt,
                lag_days = $lag,
                correlation = $corr,
                physics_score = $score,
                discovered_by = $by
        """, {
            "src": f"{edge.source_dataset}.{edge.source_variable}",
            "tgt": f"{edge.target_dataset}.{edge.target_variable}",
            "lag": edge.lag_days,
            "corr": edge.correlation,
            "score": edge.physics_score,
            "by": edge.discovered_by,
        })
    
    async def get_precursors(self, target: str, min_score: float = 0.5) -> List[Dict]:
        result = await self.db.query("""
            SELECT * FROM causal_edge 
            WHERE target = $t AND physics_score >= $min
            ORDER BY physics_score DESC
        """, {"t": target, "min": min_score})
        return result
```

## Test Command
```bash
source .venv/bin/activate
python -c "from src.data_manager.causal_graph import CausalGraphDB; print('Import OK')"
```

## Done Criteria
- [ ] File exists at `src/data_manager/causal_graph.py`
- [ ] Import works
- [ ] Can connect to SurrealDB (requires docker running)

## Next Task
→ Integration with PCMCI engine
